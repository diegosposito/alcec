<?php

/**
 * ExpedientesEgresadosTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ExpedientesEgresadosTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object ExpedientesEgresadosTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('ExpedientesEgresados');
    }  

    // Obtener expedientes asignados de las demas areas
    public function obtenerExpedientes($idarea) 
    {      
    	if($idarea==29) {
    		$where = "ex.activo=1";
    	} else {
    		$where = "((de.idareaorigen=".$idarea.") OR (de.idareadestino=".$idarea.")) AND ex.activo=1";
    	}
    	// se obtienen todas las expedientes
		$resultado = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
				SELECT DISTINCT ex.*, de.idderivacion AS idderivacion, de.idareadestino AS idareadestino, de.idareaorigen AS idareaorigen, ca.idcarrera AS idcarrera
				FROM expedientes_egresados ex
				INNER JOIN alumnos al ON ex.idalumno=al.idalumno
				INNER JOIN planes_estudios pl ON al.idplanestudio=pl.idplanestudio
				INNER JOIN carreras ca ON pl.idcarrera=ca.idcarrera
				INNER JOIN areas_carrera ac ON ca.idcarrera=ac.idcarrera			
    			INNER JOIN ( 
					SELECT * FROM (
	    					SELECT * 
	    					FROM expedientes_derivaciones
	    					ORDER BY idderivacion DESC
						) AS der
						GROUP BY der.idexpediente
    			) AS de ON ex.idexpediente=de.idexpediente
    			WHERE ".$where."
				ORDER BY ca.nombre ASC"
			);
	    			
        return $resultado;
    }    
    
    // Obtener expedientes asignados de las demas areas
    public function obtenerExpedientesPorOrigen($idarea)
    {
    	if($idarea==29 or $idarea==31) {
    		$where = "ex.activo=1";
    	} else {
    		$where = "de.idareaorigen=".$idarea." AND ex.activo=1";
    	}
    	// se obtienen todas las expedientes
    	$resultado = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
				SELECT DISTINCT ex.*, de.idderivacion AS idderivacion, de.idareadestino AS idareadestino, de.idareaorigen AS idareaorigen, ca.idcarrera AS idcarrera
				FROM expedientes_egresados ex
				INNER JOIN alumnos al ON ex.idalumno=al.idalumno
				INNER JOIN planes_estudios pl ON al.idplanestudio=pl.idplanestudio
				INNER JOIN carreras ca ON pl.idcarrera=ca.idcarrera
				INNER JOIN areas_carrera ac ON ca.idcarrera=ac.idcarrera
    			INNER JOIN (
					SELECT * FROM (
	    					SELECT *
	    					FROM expedientes_derivaciones
	    					ORDER BY idderivacion ASC
						) AS der
						GROUP BY der.idexpediente
    			) AS de ON ex.idexpediente=de.idexpediente
    			WHERE ".$where."
				ORDER BY ca.nombre ASC"
    	);
    
    	return $resultado;
    }    
}