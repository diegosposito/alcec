<?php

/**
 * MateriasPlanes
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    sig
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MateriasPlanes extends BaseMateriasPlanes
{
    public function __toString() {
        return $this->getMaterias()->getNombre();
    }	

    // Obtiene todos los alumnos que tienen aprobada la materia
    public function obtenerAlumnosAprobados() 
    {  
    	$q = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
    		SELECT ex.*, ca.idmateriaplan as idmateriaplan 
    			FROM examenes ex
    			INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
    			INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
    			WHERE
    				ca.idmateriaplan = ".$this->getIdmateriaplan()."
    				AND ((ex.promedio >=4) OR (ex.promedio LIKE 'A%') OR (me.idtipoexamen = 4))
    			GROUP BY ex.idalumno
    	");	    	
	    	
		return $q;    	
    }
        
    // Obtiene todos los alumnos que estan en condiciones de aprobar la materia
    public function obtenerNotaAlumnoEnCondicion($idsede) 
    {      	
    		$q = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
					SELECT ex.idalumno AS idalumno, notas.valor AS valor, notas.notapromedio AS promedio, notas.notaescrita AS notaescrita, notas.notaoral AS notaoral
					FROM examenes ex
					INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
					INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
					INNER JOIN materias_planes mp ON ca.idmateriaplan = mp.idmateriaplan
					INNER JOIN (
						SELECT ex.idalumno, ca.idmateriaplan, SUM(mg.valormateria) AS valor, AVG(ex.promedio) AS notapromedio, AVG(ex.escrito) AS notaescrita, AVG(ex.oral) AS notaoral
						FROM examenes ex
						INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
						INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
						INNER JOIN materias_genericas mg ON ca.idmateriaplan = mg.idmateriaplan
						WHERE
							mg.idmateriaplangenerica=".$this->getIdmateriaplan()."
							AND me.idestadomesaexamen <> 5
							AND me.idestadomesaexamen <> 6
							AND ((ex.promedio >=4) OR (ex.promedio LIKE 'A%') OR (me.idtipoexamen = 4))
							AND ex.idalumno".$idalumno."
						GROUP BY ex.idalumno
					) as notas ON ex.idalumno = notas.idalumno
					WHERE
						notas.valor >= (SELECT puntajerequerido FROM materias_planes WHERE idmateriaplan=".$this->getIdmateriaplan()." GROUP BY idmateriaplan)   
						AND ex.idalumno NOT IN (
					   		SELECT ex.idalumno 
		    				FROM examenes ex
		    				INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
		    				INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
		    				WHERE
		    					ca.idmateriaplan = ".$this->getIdmateriaplan()."
								AND me.idestadomesaexamen <> 5
								AND me.idestadomesaexamen <> 6		    				
		    					AND ((ex.promedio >=4) OR (ex.promedio LIKE 'A%') OR (me.idtipoexamen = 4))
		    					AND ex.idalumno".$idalumno."
		    				GROUP BY ex.idalumno
					) GROUP BY ex.idalumno"
    		);
    		
		return $q;    	
    } 
        
    // Obtiene todos los alumnos que estan en condiciones de aprobar la materia
    public function obtenerAlumnosEnCondiciones($idsede) 
    {      	
    		$q = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
					SELECT ex.idalumno AS idalumno, notas.valor AS valor, notas.notapromedio AS promedio, notas.notaescrita AS notaescrita, notas.notaoral AS notaoral
					FROM examenes ex
					INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
					INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
					INNER JOIN materias_planes mp ON ca.idmateriaplan = mp.idmateriaplan
					INNER JOIN (
						SELECT ex.idalumno, ca.idmateriaplan, SUM(mg.valormateria) AS valor, AVG(ex.promedio) AS notapromedio, AVG(ex.escrito) AS notaescrita, AVG(ex.oral) AS notaoral
						FROM examenes ex
						INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
						INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
						INNER JOIN materias_genericas mg ON ca.idmateriaplan = mg.idmateriaplan
						WHERE
							mg.idmateriaplangenerica=".$this->getIdmateriaplan()."
							AND me.idestadomesaexamen <> 5
							AND me.idestadomesaexamen <> 6
							AND ((ex.promedio >=4) OR (ex.promedio LIKE 'A%') OR (me.idtipoexamen = 4))
						GROUP BY ex.idalumno
					) as notas ON ex.idalumno = notas.idalumno
					WHERE
						notas.valor >= (SELECT puntajerequerido FROM materias_planes WHERE idmateriaplan=".$this->getIdmateriaplan()." GROUP BY idmateriaplan)   
						AND ex.idalumno NOT IN (
					   		SELECT ex.idalumno 
		    				FROM examenes ex
		    				INNER JOIN mesas_examenes me ON ex.idmesaexamen = me.idmesaexamen
		    				INNER JOIN catedras ca ON me.idcatedra = ca.idcatedra
		    				WHERE
		    					ca.idmateriaplan = ".$this->getIdmateriaplan()."
								AND me.idestadomesaexamen <> 5
								AND me.idestadomesaexamen <> 6		    				
		    					AND ((ex.promedio >=4) OR (ex.promedio LIKE 'A%') OR (me.idtipoexamen = 4))
		    				GROUP BY ex.idalumno
					) GROUP BY ex.idalumno	
    		");
    		
		return $q;    	
    } 
       
    // Obtener las materias optativas de la materia
    public function getMateriasGenericas()
    {
    	$q = Doctrine_Query::create()
    		->select('mg.*')
    		->from('MateriasGenericas mg')
    		->innerJoin('mg.MateriasPlanes mp ON mg.idmateriaplangenerica = mp.idmateriaplan')
    		->where('mg.idmateriaplan = '.$this->getIdmateriaplan());
    	 
    	return $q->execute();
    }
        
    // Obtener las materias optativas de la materia
    public function obtenerMateriasComponentes() 
    {
	    $q = Doctrine_Query::create()
	  		->select('m.*')
	 		->from('MateriasGenericas m')
	    	->where('m.idmateriaplangenerica = '.$this->getIdmateriaplan());
     
		return $q->execute();
    }   

    // Obtener las materias optativas de la materia
    public function obtenerPuntajeSumado($idmateriaplan,$idalumno)
    {
    	$sumapuntaje = 0;
    	
    	$q = Doctrine_Query::create()
    		->select('m.*')
    		->from('MateriasGenericas m')
    		->where('m.idmateriaplangenerica = '.$this->getIdmateriaplan())
    		->execute();
    	 
		foreach($q as $item) {
			$oAluMat = Doctrine::getTable('AluMat')->tieneAprobado($idalumno,$item['idmateriaplan']);
			if ($oAluMat or $idmateriaplan==$item['idmateriaplan']) {
				$sumapuntaje = $sumapuntaje + $item['valormateria'];
			}
		}
		return $sumapuntaje;
		
    }
    
    // Obtener las materias optativas de la materia
    public function obtenerPromedio($idmateriaplan,$idalumno)
    {
    	$q = Doctrine_Query::create()
    		->select('m.*')
    		->from('MateriasGenericas m')
    		->where('m.idmateriaplangenerica = '.$this->getIdmateriaplan())
    		->execute();
    	
		$i = 0;    
		$nota = 0;
		$promedio = 0;
		
    	foreach($q as $item) {
    		$oAluMat = Doctrine::getTable('AluMat')->tieneAprobado($idalumno,$item['idmateriaplan']);
    		
    		if ($oAluMat or $idmateriaplan==$item['idmateriaplan']) {
    			$oCatedra = Doctrine::getTable('Catedras')->obtenerCatedra($item['idmateriaplan'], $oAluMat->getAlumnos()->getIdsede());
    			$oExamen = Doctrine::getTable('Examenes')->getUltimoExamen($idalumno, $oCatedra->getIdcatedra());
    			$nota = $nota + $oExamen->getPromedio();
    			$i++;
    		}
    	}
    	$promedio = $nota / $i;
    	
    	return $promedio;
    }    
        
    // Obtener las comisiones 
	public function obtenerComisiones($idsede) 
	{
		$q = Doctrine_Query::create()
			->select('co.*')
			->from('Comisiones co')
			->innerJoin('co.Catedras ca ON co.idcatedra = ca.idcatedra')
			->where('ca.idsede = '.$idsede)
			->andWhere('ca.idmateriaplan = '.$this->getIdmateriaplan())
			->execute();			
   			
		return $q;
	}  

	// Obtener las comisiones que tienen cupo
	public function obtenerComisionesConCupo($idsede)
	{
		$arreglo = array();

		$q = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
    			SELECT co.*
    			FROM comisiones co
    			INNER JOIN catedras ca ON co.idcatedra=ca.idcatedra
    			WHERE
    				ca.idsede = ".$idsede."
 					AND ca.idmateriaplan=".$this->getIdmateriaplan()
		);		
		
		foreach($q as $item) {
			$inscriptos = Doctrine_Core::getTable('AluMat')->getCantidadAlumnosCursando($item['idcomision']);
			if ($item['capacidad'] > $inscriptos) {	
				$oComision = Doctrine_Core::getTable('Comisiones')->find($item['idcomision']);
				$arreglo[$item['idcomision']] = $oComision;
			}		
		}
		return $arreglo;
	}
		
    // Obtener catedra 
	public function obtenerCatedra($idsede) 
	{
		$q = Doctrine_Query::create()
			->select('ca.*')
			->from('Catedras ca')
			->where('ca.idsede = '.$idsede)
			->andWhere('ca.idmateriaplan = '.$this->getIdmateriaplan());			
   			
		return $q->fetchOne();
	}  	
}