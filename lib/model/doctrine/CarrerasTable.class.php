<?php

/**
 * CarrerasTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class CarrerasTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object CarrerasTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Carreras');
    }
    
    // Obtiene la oferta academica
    public static function obtenerOfertaAcademica()
    {
    	/*
    	 $q = Doctrine_Query::create()
    		->select('ca.nombre as nombre, ca.titulo as titulo,ac.idarea')
    		->from('AreasCarrera ac')
    		->innerJoin('ac.Carreras ca ON ac.idcarrera = ca.idcarrera')
    		->innerJoin('ac.Areas ar ON ac.idarea = ar.idarea')
    		->where('ca.idtipocarrera IN (3, 4, 5)')
    		->andWhere('ar.idtipoarea IN (3, 5, 7)')
    		->execute();
    	*/
    	
    	$q = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
			SELECT ac.id as id, ca.nombre as nombre, ca.titulo as titulo,ac.idarea, ca.idcarrera
			FROM areas_carrera ac
			INNER JOIN carreras ca ON ac.idcarrera = ca.idcarrera
			INNER JOIN areas ar ON ac.idarea = ar.idarea
			INNER JOIN planes_estudios pe ON ca.idcarrera = pe.idcarrera
			WHERE 
    			ca.idtipocarrera IN (3,4,5) 
    			AND ar.idtipoarea IN (3,5,7)
    			AND pe.idestadoplan = 2 
            ");
    	
    	foreach ($q as $item){
    		$arreglo[$item['id']] = Doctrine_Core::getTable('AreasCarrera')->find($item['id']);
    	}
    	
    	return $arreglo;    	
    }
        
    // Obtiene los planes de estudio asociado a una carrera
    public static function obtenerPlanesEstudio($idcarrera)
    {
		$q = Doctrine_Query::create()
  			->select('p.*')
    		->from('PlanesEstudios p')
    		->where('p.idcarrera = '.$idcarrera);

		return $q->execute();
    } 
    
    // Obtiene las sedes asociado a una carrera
    public static function obtenerSedes($idcarrera)
    {
		$q = Doctrine_Query::create()
  			->select('s.nombre as nombre, c.*')
    		->from('CarrerasSede c')
    		->innerJoin('c.Sedes s ON c.idsede = s.idsede')
    		->where('c.idcarrera = '.$idcarrera);

		return $q->execute();
    }     

    // Obtiene carreras para una sede
    public static function obtenerCarrerasxfacultad()
    {
        $idfacultad = Doctrine_Core::getTable('AreasCarrera')->obtenerFacultadxdesignacion();
        
        $q = Doctrine_Query::create()
            ->select('c.*, pe.*')
            ->from('PlanesEstudios pe')
            ->innerJoin('pe.Carreras c ON pe.idcarrera = c.idcarrera')
            ->innerJoin('c.AreasCarrera ac ON c.idcarrera = ac.idcarrera')
            ->where('c.idfacultad = '.$idfacultad)
            ->andWhere('ac.idarea = '.sfContext::getInstance()->getUser()->getProfile()->getIdArea())
            ->andWhere('pe.idestadoplan IN (2 , 4)');
       
        return $q;
    } 

    // Obtiene carreras por facultad (sin discriminar de que sede es)
    public static function obtenerCarrerasPorFacultad($idfacultad)
    {
        $sql = " SELECT DISTINCT pe.idplanestudio, car.nombre, CONCAT(car.nombre , ' - ', pe.nombre) as carreraplan FROM carreras car
                    JOIN planes_estudios pe ON car.idcarrera = pe.idcarrera
                    JOIN facultades fac ON car.idfacultad = fac.idfacultad
                    WHERE pe.idestadoplan IN (2,4)";
        
        if ($idfacultad<>'')
            $sql .= " AND fac.idfacultad = ".$idfacultad.""; 

        $sql .= " ORDER BY car.nombre";

        $resultado = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc($sql);

        return $resultado;      
    } 

    // Obtiene planes de estudios por facultad /sede
    public static function obtenerPlanesPorSedeFacultad ($idsede, $idfacultad='')
    {
        $sql = " SELECT pe.idplanestudio, car.nombre, CONCAT(car.nombre , ' - ', pe.nombre) as carreraplan 
                    FROM carreras car
                    JOIN planes_estudios pe ON car.idcarrera = pe.idcarrera
                    JOIN (
                        SELECT DISTINCT mp.idplanestudio 
                        FROM designaciones des 
                        JOIN catedras cat ON des.idcatedra = cat.idcatedra
                        JOIN materias_planes mp ON cat.idmateriaplan = mp.idmateriaplan
                        WHERE cat.idsede= ".$idsede."
                        ) as planes ON pe.idplanestudio = planes.idplanestudio
                    JOIN facultades fac ON car.idfacultad = fac.idfacultad
                    WHERE pe.idestadoplan IN (2,4) ";

        if ($idfacultad<>'')
            $sql .= " AND fac.idfacultad = ".$idfacultad.""; 

        $sql .= " ORDER BY carreraplan";

        $resultado = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc($sql);

        return $resultado;      
    } 

}