<?php

/**
 * DocumentacionAlumnosTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class DocumentacionAlumnosTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object DocumentacionAlumnosTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('DocumentacionAlumnos');
    }
    
    // Obtener los datos especificos de una documantecion
    public function obtenerDocumentacionesPorIdalumno($idalumno)
    {
    	$q = Doctrine_Query::create()
    		->select('da.*')
    		->from('DocumentacionAlumnos da')
    		->where('da.idalumno = '.$idalumno);
    
    	return $q->execute();
    }
    
    // Obtener los datos especificos de una documantecion
    public function obtenerDocumentacionPlanEstudio($idalumno,$iddocumentacion)
    {
    	$resultado = 0;
    	    	
    	$q = Doctrine_Query::create()
    		->select('da.*')
    		->from('DocumentacionAlumnos da')
    		->where('da.idalumno = '.$idalumno)
    		->andWhere('da.iddocumentacion = '.$iddocumentacion)
    		->execute();
    
    	if (count($q)>0){
    		$resultado = 1;
    	}
    	
    	return $resultado;
    }    
    
    // Obtener los alumnos con documentacion habilitante
    public function obtenerAlumnosConDocumentacion($idcomision)
    {
    	$arreglo = array();
    	$fechaactual = date('Y-m-d');
    	
    	$q = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("
    		SELECT do.idalumno as idalumno
    		FROM alu_mat am
    		INNER JOIN (
    			SELECT * FROM (
    				SELECT *
    				FROM estados_alumno_historial
    				ORDER BY fecha DESC, id DESC
    			) AS eah
    			GROUP BY eah.idalumno
    		) AS ea ON am.idalumno = ea.idalumno
    		INNER JOIN alumnos al ON am.idalumno=al.idalumno
    		INNER JOIN documentacion_alumnos do ON al.idalumno=do.idalumno
    		INNER JOIN planes_estudios pe ON al.idplanestudio = pe.idplanestudio
    		INNER JOIN carreras ca ON pe.idcarrera = ca.idcarrera
    		WHERE
    			am.idcomision = ".$idcomision."
    			AND ea.idestadoalumno=1
    			AND am.idestadomateria=1
    			AND ((ca.idtipocarrera = 8 AND ((do.iddocumentacion = 8 AND al.fechacerttittramite>='".$fechaactual."') OR do.iddocumentacion = 22)) OR (ca.idtipocarrera = 10 AND (do.iddocumentacion = 37 OR do.iddocumentacion = 22)) OR (do.iddocumentacion = 9 OR (do.iddocumentacion = 8 AND al.fechacerttittramite>='".$fechaactual."') OR ca.idtipocarrera = 6))
    	");
    	foreach($q as $item) {
    		$arreglo[$item['idalumno']]=$item['idalumno'];
    	}
    	
    	return $arreglo;    
    }
}